<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 Cheney.Yin 的个人博客">
    <meta name="keywords" content="CHeney.Yin Blog, 博客, 个人网站, 互联网, Web, JavaScript, Database, Hadoop, Spark, Docker, 设计">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="Cgroup v2 - Cheney.Yin的博客 | Cheney Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="cgroup v2
">
    
    <meta property="article:published_time" content=" 2021-11-11T00:00:00Z">
    
    
    <meta property="article:author" content="Cheney.Yin">
    
    
    <meta property="article:tag" content="Linux">
    
    <meta property="article:tag" content="Cgroup">
    
    <meta property="article:tag" content="Cgroup v2">
    
    <meta property="article:tag" content="mount">
    
    <meta property="article:tag" content="Cgroup Controller">
    
    <meta property="article:tag" content="CPU">
    
    <meta property="article:tag" content="Memory">
    
    <meta property="article:tag" content="IO">
    
    <meta property="article:tag" content="fio">
    
    
    <meta property="og:image" content="https://cheneyyin.github.io/img/cheney.jpg">
    <meta property="og:url" content="https://cheneyyin.github.io/2021/11/11/cgroup-v2/">
    <meta property="og:site_name" content="Cheney.Yin的博客 | Cheney Blog">

    <title>Cgroup v2 - Cheney.Yin的博客 | Cheney Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://cheneyyin.github.io/2021/11/11/cgroup-v2/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Cheney.Yin Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/bg-material.jpg');
        background: ;
    }

    
</style>




<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=Linux" title="Linux">Linux</a>
                        
                        <a class="tag" href="/archive/?tag=Cgroup" title="Cgroup">Cgroup</a>
                        
                        <a class="tag" href="/archive/?tag=Cgroup+v2" title="Cgroup v2">Cgroup v2</a>
                        
                        <a class="tag" href="/archive/?tag=mount" title="mount">mount</a>
                        
                        <a class="tag" href="/archive/?tag=Cgroup+Controller" title="Cgroup Controller">Cgroup Controller</a>
                        
                        <a class="tag" href="/archive/?tag=CPU" title="CPU">CPU</a>
                        
                        <a class="tag" href="/archive/?tag=Memory" title="Memory">Memory</a>
                        
                        <a class="tag" href="/archive/?tag=IO" title="IO">IO</a>
                        
                        <a class="tag" href="/archive/?tag=fio" title="fio">fio</a>
                        
                    </div>
                    <h1>Cgroup v2</h1>
                    
                    <h2 class="subheading">介绍Cgroup相关概念和常用命令</h2>
                    <span class="meta">Posted by Cheney.Yin on November 11, 2021</span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h1 id="cgroup-v2">cgroup v2</h1>

<p><a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html">详细参考</a></p>

<h2 id="概况">概况</h2>

<p><strong>cgroup</strong>是一个目录树，每层目录下都可以创建子目录，子目录默认继承父目录的属性，具有层级结构。</p>

<p><strong>cgroup</strong>把一个<strong>cgroup</strong>目录中的资源划分给它的子目录，子目录可以把资源继续划分给它的子目录，<strong>子目录分配的资源之和不能超过父目录</strong>，进程或者线程可以使用的资源受到它们委身的目录中的资源的限制。</p>

<p><strong>cgroup v2</strong>和<strong>cgroup v1</strong>区别很大，这一点可以反映在目录结构下，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre>ll /sys/fs/cgroup
total 0
  1 0 dr-xr-xr-x 12 root root 0 11月 24 09:34 <span class="nb">.</span>
  2 0 drwxr-xr-x  7 root root 0 11月 24 09:09 ..
  4 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:09 cgroup.controllers
  7 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:25 cgroup.max.depth
  6 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:25 cgroup.max.descendants
  2 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:09 cgroup.procs
  8 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:25 cgroup.stat
  5 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:09 cgroup.subtree_control
  3 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:25 cgroup.threads
 12 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:25 cpu.pressure
 13 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:25 cpuset.cpus.effective
 14 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:25 cpuset.mems.effective
  9 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:25 cpu.stat
213 0 drwxr-xr-x  2 root root 0 11月 24 09:09 dev-hugepages.mount
245 0 drwxr-xr-x  2 root root 0 11月 24 09:09 dev-mqueue.mount
 21 0 drwxr-xr-x  2 root root 0 11月 24 09:09 init.scope
 20 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:25 io.cost.model
 19 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:25 io.cost.qos
 10 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:25 io.pressure
 15 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:25 io.stat
 17 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:25 memory.numa_stat
 11 0 <span class="nt">-rw-r--r--</span>  1 root root 0 11月 24 09:25 memory.pressure
 16 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:25 memory.stat
 18 0 <span class="nt">-r--r--r--</span>  1 root root 0 11月 24 09:25 misc.capacity
725 0 drwxr-xr-x  2 root root 0 11月 24 09:09 proc-sys-fs-binfmt_misc.mount
661 0 drwxr-xr-x  2 root root 0 11月 24 09:09 sys-fs-fuse-connections.mount
693 0 drwxr-xr-x  2 root root 0 11月 24 09:09 sys-kernel-config.mount
277 0 drwxr-xr-x  2 root root 0 11月 24 09:09 sys-kernel-debug.mount
309 0 drwxr-xr-x  2 root root 0 11月 24 09:09 sys-kernel-tracing.mount
 53 0 drwxr-xr-x 25 root root 0 11月 24 09:38 system.slice
181 0 drwxr-xr-x  3 root root 0 11月 24 09:11 user.slice
</pre></td></tr></tbody></table></code></pre></div></div>

<p>目录下的文件用来设置控制器，这些文件被称作<strong>cgroup控制器的文件接口</strong>。其中，<code class="language-plaintext highlighter-rouge">cgroup.controllers</code>中存放了支持的<strong>cgroup Controller</strong>类型，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cat</span> /sys/fs/cgroup/cgroup.controllers
cpuset cpu io memory hugetlb pids rdma misc
</pre></td></tr></tbody></table></code></pre></div></div>

<p>controller默认是为开启的。通过向<code class="language-plaintext highlighter-rouge">cgroup.subtree_control</code>文件写数据，来子目录可用的资源控制器。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">cat</span> /sys/fs/cgroup/cgroup.subtree_control
memory pids
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这说明子目录的内存控制器、pids控制器是开启的。</p>

<p>开启<code class="language-plaintext highlighter-rouge">cpu</code>控制器(<strong>以root用户操作</strong>)，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'+cpu'</span> <span class="o">&gt;</span> /sys/fs/cgroup/cgroup.subtree_control
<span class="nb">cat</span> /sys/fs/cgroup/cgroup.subtree_control
cpu memory pids
</pre></td></tr></tbody></table></code></pre></div></div>

<p>关闭<code class="language-plaintext highlighter-rouge">cpu</code>控制器，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'-cpu'</span> <span class="o">&gt;</span> /sys/fs/cgroup/cgroup.subtree_control
<span class="nb">cat</span> /sys/fs/cgroup/cgroup.subtree_control
memory pids
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>Only controllers which are listed in “cgroup.controllers” can be enabled. When multiple operations are specified as above, either they <strong>all succeed or fail</strong>. If <strong>multiple</strong> operations on the <strong>same controller</strong> are specified, <strong>the last one is effective</strong>.</p>
</blockquote>

<p><strong>子目录的<code class="language-plaintext highlighter-rouge">cgroup.controllers</code>受限于父目录的<code class="language-plaintext highlighter-rouge">cgroup.subtree_control</code></strong>。</p>

<p>例如父目录开启了<code class="language-plaintext highlighter-rouge">cpu</code>、<code class="language-plaintext highlighter-rouge">memory</code>、<code class="language-plaintext highlighter-rouge">pids</code>，则子目录仅能开启<code class="language-plaintext highlighter-rouge">cpu</code>、<code class="language-plaintext highlighter-rouge">memory</code>、<code class="language-plaintext highlighter-rouge">pids</code>。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir</span> /sys/fs/cgroup/A                                                               <span class="nb">cat</span> /sys/fs/cgroup/A/cgroup.controllers                                             cpu memory pids
<span class="nb">cat</span> /sys/fs/cgroup/A/cgroup.subtree_control                                         <span class="nb">mkdir</span> /sys/fs/cgroup/A/B 
<span class="nb">cat</span> /sys/fs/cgroup/A/B/cgroup.controllers                                           <span class="nb">echo</span> <span class="s1">'+cpu'</span> <span class="o">&gt;</span> /sys/fs/cgroup/A/cgroup.subtree_control                               <span class="nb">cat</span> /sys/fs/cgroup/A/B/cgroup.controllers                                           cpu
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'(A:[ACtrl]{label:"controllers:cpu memory pids"}[ASubCtrl]{label:"subtree control:cpu"}) (B:[BCtrl]{label:"controllers:cpu"}[BSubCtrl]{label:"subtree control:"}) [ASubCtrl]-&gt;[ACtrl] [BCtrl]-&gt;[ASubCtrl] {flow:south}'</span> | graph-easy
+ - - - - - - - - - - -+     +- - - - - - - - - - - - - - - - -+
<span class="s1">' B:                   '</span>     <span class="s1">' A:                              '</span>
<span class="s1">'                      '</span>     <span class="s1">'                                 '</span>
<span class="s1">' +------------------+ '</span>     <span class="s1">' +-----------------------------+ '</span>
<span class="s1">' | controllers:cpu  | '</span> <span class="nt">--</span><span class="o">&gt;</span> <span class="s1">' |     subtree control:cpu     | '</span>
<span class="s1">' +------------------+ '</span>     <span class="s1">' +-----------------------------+ '</span>
<span class="s1">'                      '</span>     <span class="s1">'   |                             '</span>
<span class="s1">'                      '</span>     <span class="s1">'   |                             '</span>
<span class="s1">'                      '</span>     <span class="s1">'   v                             '</span>
<span class="s1">' +------------------+ '</span>     <span class="s1">' +-----------------------------+ '</span>
<span class="s1">' | subtree control: | '</span>     <span class="s1">' | controllers:cpu memory pids | '</span>
<span class="s1">' +------------------+ '</span>     <span class="s1">' +-----------------------------+ '</span>
<span class="s1">'                      '</span>     <span class="s1">'                                 '</span>
+ - - - - - - - - - - -+     +- - - - - - - - - - - - - - - - -+
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="挂载cgroup-controller">挂载cgroup Controller</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir </span>mnt_cgroup
<span class="nb">sudo </span>mount <span class="nt">-t</span> cgroup2 cgroup2 ./mnt_cgroup
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在<code class="language-plaintext highlighter-rouge">mnt_cgroup</code>目录下，可以看到类似与<code class="language-plaintext highlighter-rouge">/sys/fs/cgroup</code>结构。</p>

<h2 id="控制器目录结构">控制器目录结构</h2>

<p>在cgroup v2中，进程只能加入到<strong>叶子目录节点</strong>（<strong>*除cgroup根节点外</strong>）。</p>

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/img/resources/cgroupv2-case1.svg" width="75%" alt="" />
    <br />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">
      图1 cgroup v2目录结构1
  	</div>
</center>

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/img/resources/cgroupv2-case2.svg" width="75%" alt="" />
    <br />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">
      图2 cgroup v2目录结构2
  	</div>
</center>

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/img/resources/cgroupv2-case3.svg" width="75%" alt="" />
    <br />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">
      图3 cgroup v2目录结构3
  	</div>
</center>

<p>然而，CPU控制器和内存控制器判定子目录的方法稍有区别。</p>

<p>在图1中，A、B目录均<strong>没有追加任何进程</strong>（初始状态）。受CPU控制器影响，</p>

<ul>
  <li>如果B目录追加了进程，那么B目录将成为子目录，那么A目录将无法追加任何进程。</li>
  <li>如果A目录先追加进程，那么A目录将成为子目录，那么B目录将废弃，无法追加任何进程。</li>
</ul>

<p>在图2中，A、B目录均<strong>没有追加任何进程</strong>（初始状态）。受内存控制器影响，</p>

<ul>
  <li>B目录为子目录，A目录不能追加任何进程。</li>
</ul>

<p>在图3中，A、B目录均<strong>没有追加任何进程</strong>（初始状态）。虽然，B目录同时支持CPU控制器、内存控制器，但是B目录会默认成为子目录。A、B并不会根据追加进程先后判断子目录，因为受内存控制器作用，A目录是无法追加任何进程。</p>

<p>本质上，<strong><em>一个cgroup目录如果绑定了进程，那么它的<code class="language-plaintext highlighter-rouge">cgroup.subtree_control</code>必须为空，或者反过来必须不绑定进程，<code class="language-plaintext highlighter-rouge">cgroup.subtree_control</code>中才可以有内容。</em></strong></p>

<blockquote>
  <p>More precisely, the rule is that a (nonroot) cgroup can’t both (1) have member processes, and (2) distribute resources into child cgroups—that is, have a nonempty cgroup.subtree_control file.</p>
</blockquote>

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="/img/resources/cgroupv2-case4.svg" width="75%" alt="" />
    <br />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">
      图4 cgroup v2目录结构4
  	</div>
</center>

<p>如果，中间目录的控制器规则满足某个进程的需要，那么应该如何处理呢？</p>

<p>参考图4，假如<code class="language-plaintext highlighter-rouge">cg1</code>满足进程的需要，可以在<code class="language-plaintext highlighter-rouge">cg1</code>建立一个<strong>叶子子目录</strong><code class="language-plaintext highlighter-rouge">leaf_cg1</code>，该目录下的控制其规则默认继承自<code class="language-plaintext highlighter-rouge">cg1</code>，可以将进程绑定在<code class="language-plaintext highlighter-rouge">leaf_cg1</code>上。</p>

<h2 id="进程控制器和线程控制器">进程控制器和线程控制器</h2>

<p>从<strong>Linux kernel 4.14</strong>开始，<strong>cgroup v2</strong> 引入了<strong><em>thread mode</em></strong>（线程模式），controller被分为<strong>domain controller</strong>（cgroup进程控制器）和<strong>threaded controller</strong>（cgroup线程控制器）。</p>

<p><strong>cgroup</strong>目录有了类型之分：只管理进程的<strong>cgroup</strong>目录是<strong>domain cgroup</strong>，称为<strong>进程(子)目录</strong>；新增的管理线程的<strong>cgroup</strong>目录是<strong>threaded cgroup</strong>，称为<strong>线程子目录</strong>。</p>

<h2 id="cgroup控制器core接口文件">cgroup控制器core接口文件</h2>

<h3 id="cgrouptype">cgroup.type</h3>

<p>当前<strong>cgroup</strong>的类型，<strong>cgroup</strong>类型包括：</p>

<ul>
  <li><strong>domain</strong>：默认类型。</li>
  <li><strong>domain threaded</strong>：作为threaded类型<strong>cgroup</strong>的根结点。</li>
  <li><strong>domain invalid</strong>：无效状态<strong>cgroup</strong>。</li>
  <li><strong>threaded</strong>：threaded类型的<strong>cgroup</strong>组。</li>
</ul>

<h3 id="cgroupprocs">cgroup.procs</h3>

<p>该文件是当前<strong>cgroup</strong>的PID列表，向该文件<code class="language-plaintext highlighter-rouge">echo $pid</code>，可以使<code class="language-plaintext highlighter-rouge">$pid</code>加入组。</p>

<p>一个<code class="language-plaintext highlighter-rouge">pid</code>可以从一个组迁移到另一个组，但要满足以下两项条件，</p>

<ul>
  <li>进程对新组有写访问权限。</li>
  <li>源组和目的组拥有共同的祖先。</li>
</ul>

<h3 id="cgroupthreads">cgroup.threads</h3>

<p>该文件是当前<strong>cgroup</strong>的TID列表，可以控制组内线程。</p>

<h3 id="cgroupcontrollers">cgroup.controllers</h3>

<p>该文件是当前组支持的控制器类型列表。</p>

<h3 id="cgroupsubtree_control">cgroup.subtree_control</h3>

<p>该文件是子目录组开启的控制器类型列表。</p>

<h3 id="cgroupevents">cgroup.events</h3>

<p>该文件包含两个只读的<code class="language-plaintext highlighter-rouge">key-value</code>。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">populated</code>：1表示当前<strong>cgroup</strong>内有进程，0表示没有。</li>
  <li><code class="language-plaintext highlighter-rouge">frozen</code>：1表示当前<strong>cgroup</strong>为frozen状态，0表示非此状态。</li>
</ul>

<h3 id="cgroupmaxdescendants">cgroup.max.descendants</h3>

<p>当前<strong>cgroup</strong>目录中可以允许的最大子<strong>cgroup</strong>个数。默认值为max。</p>

<blockquote>
  <p>If the actual number of descendants is equal or larger, an attempt to create a new cgroup in the hierarchy will fail.</p>
</blockquote>

<p>子组数量超过该值，该目录下创建新的组会失败。</p>

<h3 id="cgroupmaxdepth">cgroup.max.depth</h3>

<p>当前<strong>cgroup</strong>目录中可以允许的最大<strong>cgroup</strong>层级数。默认值为max。</p>

<blockquote>
  <p>If the actual descent depth is equal or larger, an attempt to create a new child cgroup will fail.</p>
</blockquote>

<h3 id="cgroupstat">cgroup.stat</h3>

<p>包含两个只读的<code class="language-plaintext highlighter-rouge">key-value</code>。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">nr_descendants</code>：当前<strong>cgroup</strong>下可见的子孙<strong>cgroup</strong>个数。</li>
  <li><code class="language-plaintext highlighter-rouge">nr_dying_descendants</code>：这个<strong>cgroup</strong>下曾被创建但是已被删除的子孙<strong>cgroup</strong>个数。</li>
</ul>

<h3 id="cgroupfreeze">cgroup.freeze</h3>

<p>值为1可以将组置为<code class="language-plaintext highlighter-rouge">freeze</code>状态。默认值为0。</p>

<h3 id="cgroupkill">cgroup.kill</h3>

<blockquote>
  <p>A write-only single value file which exists in non-root cgroups. The only allowed value is “1”.</p>

  <p>Writing “1” to the file causes the cgroup and all descendant cgroups to be killed. This means that all processes located in the affected cgroup tree will be killed via SIGKILL.</p>
</blockquote>

<p>只写单值文件，向该文件写1可以杀死该组和该组的子组。</p>

<h2 id="cpu控制器">CPU控制器</h2>

<p><strong>可压缩资源</strong></p>

<h3 id="cpu接口文件">CPU接口文件</h3>

<h4 id="cpustat">cpu.stat</h4>

<p>当前<strong>cgroup</strong>的CPU消耗统计。该文件的存在意味着CPU控制器是否开启。显示的内容包括：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">usage_usec</code>：占用CPU总时间。</li>
  <li><code class="language-plaintext highlighter-rouge">user_usec</code>：用户态占用时间。</li>
  <li><code class="language-plaintext highlighter-rouge">system_usec</code>：内核态占用时间。</li>
  <li><code class="language-plaintext highlighter-rouge">nr_periods</code>：周期计数。</li>
  <li><code class="language-plaintext highlighter-rouge">nr_throttled</code>：周期内的限制计数。</li>
  <li><code class="language-plaintext highlighter-rouge">throttled_usec</code>：限制执行的时间。</li>
</ul>

<h4 id="cpuweight">cpu.weight</h4>

<p>可以通过<code class="language-plaintext highlighter-rouge">cpu.weight</code>文件来设置本<strong>cgroup</strong>的权重值。默认为<code class="language-plaintext highlighter-rouge">100</code>。取值范围为<code class="language-plaintext highlighter-rouge">[1,10000]</code>。</p>

<h4 id="cpuweightnice">cpu.weight.nice</h4>

<p>该接口文件是<code class="language-plaintext highlighter-rouge">cpu.weight</code>的替代接口，允许使用 nice 使用的相同值读取和设置权重。 因为对于 nice 值（CPU调度优先级），范围更小且粒度更粗，所以读取值是当前权重的最接近的近似值。</p>

<h4 id="cpumax">cpu.max</h4>

<p>带宽最大限制，默认<code class="language-plaintext highlighter-rouge">max 100000</code>。</p>

<p>文件遵循如下格式</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$MAX</span> <span class="nv">$PERIOD</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>表示在<code class="language-plaintext highlighter-rouge">$PERIOD</code>周期内，该组可以消耗最多<code class="language-plaintext highlighter-rouge">$MAX</code>周期。</p>

<h4 id="cpumaxburst">cpu.max.burst</h4>

<p>默认值0，取值范围为<code class="language-plaintext highlighter-rouge">[0,$MAX]</code>。</p>

<p><a href="https://www.infoq.cn/article/y2semvajjgxj9mbg9p00">参考</a></p>

<p>CPU低于配额时，burst累积；当CPU使用超出配额时，根据burst累积量，允许CPU短时超额使用。</p>

<h4 id="cpupressure">cpu.pressure</h4>

<p>显示当前<strong>cgroup</strong>的CPU使用压力状态。</p>

<h4 id="cpuuclampmin">cpu.uclamp.min</h4>

<p><a href="https://www.cxybb.com/article/qq_52358151/112558800">参考</a></p>

<p>默认值0。</p>

<p><strong>uclamp</strong>提供了一种用户空间对于<strong>task util</strong>进行限制的机制。</p>

<h4 id="cpuuclampmax">cpu.uclamp.max</h4>

<p>默认值max。</p>

<h3 id="cpu配额实例">CPU配额实例</h3>
<p>创建控制组A，CPU配额50%的CPU核。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">mkdir</span> /sys/fs/cgroup/A
<span class="nb">echo</span> <span class="s1">'+cpu'</span> <span class="o">&gt;</span> /sys/fs/cgroup/cgroup.subtree_control
<span class="nb">echo</span> <span class="s1">'50000 100000'</span> <span class="o">&gt;</span> /sys/fs/cgroup/A/cpu.max
</pre></td></tr></tbody></table></code></pre></div></div>

<p>空转任务如下：</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="nv">$$</span>
<span class="k">while</span> :
<span class="k">do</span>
	:
<span class="k">done</span>
./loop.sh
11762
</pre></td></tr></tbody></table></code></pre></div></div>
<p>空转任务CPU使用率为100%，</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>top <span class="nt">-p</span> 11762

...

   PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
  11762 cheney    20   0   10336   3132   2800 R 100.0   0.0   0:25.89 loop.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<p>为进程<code class="language-plaintext highlighter-rouge">11762</code>分配控制组A，</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'11762'</span> <span class="o">&gt;</span> /sys/fs/cgroup/A/cgroup.procs
</pre></td></tr></tbody></table></code></pre></div></div>
<p>再次查看CPU使用率为50%。</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>top <span class="nt">-p</span> 11762

...

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
  11762 cheney    20   0   10336   3184   2848 R  50.0   0.0   1:15.85 loop.sh
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="内存控制器">内存控制器</h2>

<p><strong>不可压缩资源</strong></p>

<h3 id="内存接口文件">内存接口文件</h3>

<blockquote>
  <p>All memory amounts are in bytes. If a value which is not aligned to PAGE_SIZE is written, the value may be rounded up to the closest PAGE_SIZE multiple when read back.</p>
</blockquote>

<p>内存量按照内存页大小向上对齐。</p>

<h4 id="memorymax">memory.max</h4>

<p>默认值为max，不限制。如果需要做限制，则写一个内存字节数上限到文件内就可以了。cgroup的内存使用量超过该阈值，会触发OOM。</p>

<h4 id="memorymin">memory.min</h4>

<p>这是内存的硬保护机制。如果当前<strong>cgroup</strong>的内存使用量在min值以内，则任何情况下都不会对这部分内存进行回收。如果没有可用的不受保护的可回收内存，则将oom。这个值会受到上层<strong>cgroup</strong>的min限制影响，如果所有子一级的min限制总数大于上一级<strong>cgroup</strong>的min限制，当这些子一级<strong>cgroup</strong>都要使用申请内存的时候，其总量不能超过上一级<strong>cgroup</strong>的min。这种情况下，各个<strong>cgroup</strong>的受保护内存按照min值的比率分配。如果将min值设置的比你当前可用内存还大，可能将导致持续不断的oom。如果<strong>cgroup</strong>中没有进程，这个值将被忽略。</p>

<h4 id="memoryhigh">memory.high</h4>

<p>内存使用的预警值，当内存使用量超出该值，并不会出发OOM。而是，内核会尽量回收该cgroup下的内存，使内存使用量尽量回落在该值之下。</p>

<h4 id="memorylow">memory.low</h4>

<p>内存使用下限限制，当内存使用量低于该值时，内核会尽量不回收该cgroup下的内存。</p>

<p><code class="language-plaintext highlighter-rouge">memory.high</code>和<code class="language-plaintext highlighter-rouge">memory.low</code>目的是用于控制内存回收的优先级。</p>

<p>（其余有待补充）</p>

<h3 id="内存配额实例">内存配额实例</h3>

<p>创建控制组A，内存配额512MB。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'+memory'</span> <span class="o">&gt;</span> /sys/fs/cgroup/cgroup.subtree_control
<span class="nb">mkdir</span> /sys/fs/cgroup/A/
<span class="nb">echo</span> <span class="s1">'536870912'</span> <span class="o">&gt;</span> /sys/fs/cgroup/A/memory.max
</pre></td></tr></tbody></table></code></pre></div></div>

<p>使用<code class="language-plaintext highlighter-rouge">memtester</code>申请内存，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>memtester 1G 1
memtester version 4.5.1 <span class="o">(</span>64-bit<span class="o">)</span>
Copyright <span class="o">(</span>C<span class="o">)</span> 2001-2020 Charles Cazabon.
Licensed under the GNU General Public License version 2 <span class="o">(</span>only<span class="o">)</span><span class="nb">.</span>

pagesize is 4096
pagesizemask is 0xfffffffffffff000
want 1024MB <span class="o">(</span>1073741824 bytes<span class="o">)</span>
got  1024MB <span class="o">(</span>1073741824 bytes<span class="o">)</span>, trying mlock ...locked.
Loop 1/1:
  Stuck Address       : ok
  Random Value        : ok
  Compare XOR         : ok
  Compare SUB         : ok
  Compare MUL         : ok
  Compare DIV         : ok
  Compare OR          : ok
  Compare AND         : ok
  Sequential Increment: ok
  Solid Bits          : ok
  Block Sequential    : ok
  Checkerboard        : ok
  Bit Spread          : ok
  Bit Flip            : ok
  Walking Ones        : ok
  Walking Zeroes      : ok
  8-bit Writes        : ok
  16-bit Writes       : ok

Done.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>说明进程可以申请到1GB内存。</p>

<p>打开新的shell，查看PID，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="nv">$$</span>
11110
</pre></td></tr></tbody></table></code></pre></div></div>

<p>将该进程加入到用户组A，然后测试内存申请。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'11110'</span> <span class="o">&gt;</span> /sys/fs/cgroup/A/cgroup.procs
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在<code class="language-plaintext highlighter-rouge">PID:11110</code>的shell中执行内存测试，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>memtester 1G 1
memtester version 4.5.1 <span class="o">(</span>64-bit<span class="o">)</span>
Copyright <span class="o">(</span>C<span class="o">)</span> 2001-2020 Charles Cazabon.
Licensed under the GNU General Public License version 2 <span class="o">(</span>only<span class="o">)</span><span class="nb">.</span>

pagesize is 4096
pagesizemask is 0xfffffffffffff000
want 1024MB <span class="o">(</span>1073741824 bytes<span class="o">)</span>
got  1024MB <span class="o">(</span>1073741824 bytes<span class="o">)</span>, trying mlock ...[1]    8270 killed     <span class="nb">sudo </span>memtester 1G 1
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="io控制器">IO控制器</h2>

<h3 id="io接口文件">IO接口文件</h3>

<h4 id="iomax">io.max</h4>

<p>限制读写最大速率，如下配额中包括5部分，分别为设备编号（<code class="language-plaintext highlighter-rouge">$MAJ:$MIN</code>）、读速率<code class="language-plaintext highlighter-rouge">rbps</code>（每秒可读字节数）、写速率<code class="language-plaintext highlighter-rouge">wbps</code>（每秒可写字节数）、读请求速率<code class="language-plaintext highlighter-rouge">riops</code>（每秒读请求的数量）、写请求速率<code class="language-plaintext highlighter-rouge">wiops</code>（每秒写请求的数量）。如下规则可以解释为“设备<code class="language-plaintext highlighter-rouge">8：0</code>将写速率限制在2MB/s内”。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>8：0 <span class="nv">rbps</span><span class="o">=</span>max <span class="nv">wbps</span><span class="o">=</span>2097152 <span class="nv">riops</span><span class="o">=</span>max <span class="nv">wiops</span><span class="o">=</span>max
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="iolatency">io.latency</h4>

<p>这是cgroup v2实现的一种对io负载保护的机制。可以给一个磁盘设置一个预期延时目标。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>8:0 <span class="nv">target</span><span class="o">=</span>100
</pre></td></tr></tbody></table></code></pre></div></div>

<p>如上规则可以解释为“设备<code class="language-plaintext highlighter-rouge">8：0</code>将延时预期限制在了100ms内”。</p>

<p>如果cgroup检测到当前cgroup内的io响应延迟时间超过了这个target，那么cgroup可能会限制同一个父级cgroup下的其他同级别cgroup的io负载，以尽量让当前cgroup的target达到预期。</p>

<h3 id="io配额实例">IO配额实例</h3>

<h4 id="iomax-1">io.max</h4>

<p>查看本地设备，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>fdisk <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>cheney:
Disk /dev/sda: 931.51 GiB, 1000204886016 bytes, 1953525168 sectors
Disk model: HGST HTS541010A9
Units: sectors of 1 <span class="k">*</span> 512 <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 4096 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 4096 bytes / 4096 bytes
Disklabel <span class="nb">type</span>: gpt
Disk identifier: 7855E321-8FE0-364B-8FF4-A8786BD52E33

Device          Start        End    Sectors   Size Type
/dev/sda1        4096     618495     614400   300M EFI System
/dev/sda2      618496 1926796144 1926177649 918.5G Linux filesystem
/dev/sda3  1926796145 1953520064   26723920  12.7G Linux swap
</pre></td></tr></tbody></table></code></pre></div></div>

<p>查看设备<code class="language-plaintext highlighter-rouge">/dev/sda</code>的编号，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">stat</span> <span class="nt">-c</span> %t:%T /dev/sda
8:0
</pre></td></tr></tbody></table></code></pre></div></div>

<p>创建新的cgroup并开启IO控制器，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'+io'</span> <span class="o">&gt;</span> ./cgroup.subtree_control
<span class="nb">mkdir</span> ./A
<span class="nb">echo</span> <span class="s1">'8:0 wbps=2097152'</span> <span class="o">&gt;</span> ./A/io.max
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在新的shell中测试速率，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>~/testfile <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>200 <span class="nv">oflag</span><span class="o">=</span>direct
200+0 records <span class="k">in
</span>200+0 records out
209715200 bytes <span class="o">(</span>210 MB, 200 MiB<span class="o">)</span> copied, 2.25754 s, 92.9 MB/s

<span class="nb">echo</span> <span class="nv">$$</span> <span class="o">&gt;</span> /sys/fs/cgroup/A/cgroup.procs
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>~/testfile <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>200 <span class="nv">oflag</span><span class="o">=</span>direct
200+0 records <span class="k">in
</span>200+0 records out
209715200 bytes <span class="o">(</span>210 MB, 200 MiB<span class="o">)</span> copied, 100.019 s, 2.1 MB/s
</pre></td></tr></tbody></table></code></pre></div></div>

<p>进入cgroup A后，IO速率被限制在了2MB/s。</p>

<h4 id="iolatency-1">io.latency</h4>

<p><code class="language-plaintext highlighter-rouge">fio</code>工具可以测试IO延时，</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre> fio <span class="nt">-filename</span><span class="o">=</span>testfile <span class="nt">-direct</span><span class="o">=</span>1 <span class="nt">-iodepth</span> 1 <span class="nt">-thread</span> <span class="nt">-rw</span><span class="o">=</span>write <span class="nt">-ioengine</span><span class="o">=</span><span class="nb">sync</span> <span class="nt">-bs</span><span class="o">=</span>1M <span class="nt">-size</span><span class="o">=</span>2000M <span class="nt">-numjobs</span><span class="o">=</span>1 <span class="nt">-group_reporting</span> <span class="nt">-name</span><span class="o">=</span>sqe_2000_1M
sqe_2000_1M: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>write, <span class="nv">bs</span><span class="o">=(</span>R<span class="o">)</span> 1024KiB-1024KiB, <span class="o">(</span>W<span class="o">)</span> 1024KiB-1024KiB, <span class="o">(</span>T<span class="o">)</span> 1024KiB-1024KiB, <span class="nv">ioengine</span><span class="o">=</span><span class="nb">sync</span>, <span class="nv">iodepth</span><span class="o">=</span>1
fio-3.28
Starting 1 thread
Jobs: 1 <span class="o">(</span><span class="nv">f</span><span class="o">=</span>1<span class="o">)</span>: <span class="o">[</span>W<span class="o">(</span>1<span class="o">)][</span>100.0%][w<span class="o">=</span>94.0MiB/s][w<span class="o">=</span>94 IOPS][eta 00m:00s]
sqe_2000_1M: <span class="o">(</span><span class="nv">groupid</span><span class="o">=</span>0, <span class="nb">jobs</span><span class="o">=</span>1<span class="o">)</span>: <span class="nv">err</span><span class="o">=</span> 0: <span class="nv">pid</span><span class="o">=</span>9403: Fri Nov 26 11:02:27 2021
  write: <span class="nv">IOPS</span><span class="o">=</span>94, <span class="nv">BW</span><span class="o">=</span>94.5MiB/s <span class="o">(</span>99.0MB/s<span class="o">)(</span>2000MiB/21174msec<span class="o">)</span><span class="p">;</span> 0 zone resets
    clat <span class="o">(</span>usec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>2362, <span class="nv">max</span><span class="o">=</span>98388, <span class="nv">avg</span><span class="o">=</span>10515.88, <span class="nv">stdev</span><span class="o">=</span>3383.55
     lat <span class="o">(</span>usec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>2397, <span class="nv">max</span><span class="o">=</span>98449, <span class="nv">avg</span><span class="o">=</span>10573.54, <span class="nv">stdev</span><span class="o">=</span>3384.18
    clat percentiles <span class="o">(</span>usec<span class="o">)</span>:
     |  1.00th<span class="o">=[</span> 8356],  5.00th<span class="o">=[</span> 8586], 10.00th<span class="o">=[</span> 8586], 20.00th<span class="o">=[</span>10159],
     | 30.00th<span class="o">=[</span>10290], 40.00th<span class="o">=[</span>10421], 50.00th<span class="o">=[</span>10421], 60.00th<span class="o">=[</span>10552],
     | 70.00th<span class="o">=[</span>10683], 80.00th<span class="o">=[</span>10683], 90.00th<span class="o">=[</span>10814], 95.00th<span class="o">=[</span>10945],
     | 99.00th<span class="o">=[</span>22676], 99.50th<span class="o">=[</span>31851], 99.90th<span class="o">=[</span>69731], 99.95th<span class="o">=[</span>98042],
     | 99.99th<span class="o">=[</span>98042]
   bw <span class="o">(</span>  KiB/s<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>51200, <span class="nv">max</span><span class="o">=</span>104448, <span class="nv">per</span><span class="o">=</span>100.00%, <span class="nv">avg</span><span class="o">=</span>96792.38, <span class="nv">stdev</span><span class="o">=</span>8701.39, <span class="nv">samples</span><span class="o">=</span>42
   iops        : <span class="nv">min</span><span class="o">=</span>   50, <span class="nv">max</span><span class="o">=</span>  102, <span class="nv">avg</span><span class="o">=</span>94.52, <span class="nv">stdev</span><span class="o">=</span> 8.50, <span class="nv">samples</span><span class="o">=</span>42
  lat <span class="o">(</span>msec<span class="o">)</span>   : <span class="nv">4</span><span class="o">=</span>0.05%, <span class="nv">10</span><span class="o">=</span>19.70%, <span class="nv">20</span><span class="o">=</span>79.00%, <span class="nv">50</span><span class="o">=</span>1.15%, <span class="nv">100</span><span class="o">=</span>0.10%
  cpu          : <span class="nv">usr</span><span class="o">=</span>0.83%, <span class="nv">sys</span><span class="o">=</span>1.38%, <span class="nv">ctx</span><span class="o">=</span>2005, <span class="nv">majf</span><span class="o">=</span>0, <span class="nv">minf</span><span class="o">=</span>0
  IO depths    : <span class="nv">1</span><span class="o">=</span>100.0%, <span class="nv">2</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>0.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     submit    : <span class="nv">0</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>100.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="nv">64</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     <span class="nb">complete</span>  : <span class="nv">0</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>100.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="nv">64</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     issued rwts: <span class="nv">total</span><span class="o">=</span>0,2000,0,0 <span class="nv">short</span><span class="o">=</span>0,0,0,0 <span class="nv">dropped</span><span class="o">=</span>0,0,0,0
     latency   : <span class="nv">target</span><span class="o">=</span>0, <span class="nv">window</span><span class="o">=</span>0, <span class="nv">percentile</span><span class="o">=</span>100.00%, <span class="nv">depth</span><span class="o">=</span>1

Run status group 0 <span class="o">(</span>all <span class="nb">jobs</span><span class="o">)</span>:
  WRITE: <span class="nv">bw</span><span class="o">=</span>94.5MiB/s <span class="o">(</span>99.0MB/s<span class="o">)</span>, 94.5MiB/s-94.5MiB/s <span class="o">(</span>99.0MB/s-99.0MB/s<span class="o">)</span>, <span class="nv">io</span><span class="o">=</span>2000MiB <span class="o">(</span>2097MB<span class="o">)</span>, <span class="nv">run</span><span class="o">=</span>21174-21174msec

Disk stats <span class="o">(</span><span class="nb">read</span>/write<span class="o">)</span>:
  sda: <span class="nv">ios</span><span class="o">=</span>0/2046, <span class="nv">merge</span><span class="o">=</span>0/22, <span class="nv">ticks</span><span class="o">=</span>0/21494, <span class="nv">in_queue</span><span class="o">=</span>21985, <span class="nv">util</span><span class="o">=</span>99.62%
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">clat (usec): min=2362, max=98388, avg=10515.88, stdev=3383.55</code>反映了延时情况。</p>

<p>创建cgroup A，并开启IO控制器，<code class="language-plaintext highlighter-rouge">io.latency</code>的<code class="language-plaintext highlighter-rouge">target=50</code>。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s1">'+io'</span> <span class="o">&gt;</span> ./cgroup.subtree_control
<span class="nb">mkdir</span> ./A
<span class="nb">echo</span> <span class="s1">'8:0 target=50'</span> <span class="o">&gt;</span> ./A/io.latency
</pre></td></tr></tbody></table></code></pre></div></div>

<p>开启两个<code class="language-plaintext highlighter-rouge">shell</code>（<code class="language-plaintext highlighter-rouge">shell-1</code>、<code class="language-plaintext highlighter-rouge">shell-2</code>），<code class="language-plaintext highlighter-rouge">shell-1</code>加入到A组，两个shell同时运行<code class="language-plaintext highlighter-rouge">fio</code>测试工具。</p>

<p><code class="language-plaintext highlighter-rouge">shell-1</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c"># shell-1</span>
<span class="nb">echo</span> <span class="nv">$$</span> <span class="o">&gt;</span> /sys/fs/cgroup/A/cgroup.procs
fio <span class="nt">-filename</span><span class="o">=</span>testfile-1 <span class="nt">-direct</span><span class="o">=</span>1 <span class="nt">-iodepth</span> 1 <span class="nt">-thread</span> <span class="nt">-rw</span><span class="o">=</span>write <span class="nt">-ioengine</span><span class="o">=</span><span class="nb">sync</span> <span class="nt">-bs</span><span class="o">=</span>1M <span class="nt">-size</span><span class="o">=</span>2000M <span class="nt">-numjobs</span><span class="o">=</span>1 <span class="nt">-group_reporting</span> <span class="nt">-name</span><span class="o">=</span>sqe_2000_1M
sqe_2000_1M: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>write, <span class="nv">bs</span><span class="o">=(</span>R<span class="o">)</span> 1024KiB-1024KiB, <span class="o">(</span>W<span class="o">)</span> 1024KiB-1024KiB, <span class="o">(</span>T<span class="o">)</span> 1024KiB-1024KiB, <span class="nv">ioengine</span><span class="o">=</span><span class="nb">sync</span>, <span class="nv">iodepth</span><span class="o">=</span>1
fio-3.28
Starting 1 thread
sqe_2000_1M: Laying out IO file <span class="o">(</span>1 file / 2000MiB<span class="o">)</span>
Jobs: 1 <span class="o">(</span><span class="nv">f</span><span class="o">=</span>1<span class="o">)</span>: <span class="o">[</span>W<span class="o">(</span>1<span class="o">)][</span>100.0%][w<span class="o">=</span>24.0MiB/s][w<span class="o">=</span>24 IOPS][eta 00m:00s]
sqe_2000_1M: <span class="o">(</span><span class="nv">groupid</span><span class="o">=</span>0, <span class="nb">jobs</span><span class="o">=</span>1<span class="o">)</span>: <span class="nv">err</span><span class="o">=</span> 0: <span class="nv">pid</span><span class="o">=</span>9996: Fri Nov 26 11:15:49 2021
  write: <span class="nv">IOPS</span><span class="o">=</span>23, <span class="nv">BW</span><span class="o">=</span>23.9MiB/s <span class="o">(</span>25.1MB/s<span class="o">)(</span>2000MiB/83529msec<span class="o">)</span><span class="p">;</span> 0 zone resets
    clat <span class="o">(</span>msec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>13, <span class="nv">max</span><span class="o">=</span>285, <span class="nv">avg</span><span class="o">=</span>41.69, <span class="nv">stdev</span><span class="o">=</span>11.32
     lat <span class="o">(</span>msec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>13, <span class="nv">max</span><span class="o">=</span>285, <span class="nv">avg</span><span class="o">=</span>41.75, <span class="nv">stdev</span><span class="o">=</span>11.32
    clat percentiles <span class="o">(</span>msec<span class="o">)</span>:
     |  1.00th<span class="o">=[</span>   23],  5.00th<span class="o">=[</span>   27], 10.00th<span class="o">=[</span>   36], 20.00th<span class="o">=[</span>   37],
     | 30.00th<span class="o">=[</span>   37], 40.00th<span class="o">=[</span>   39], 50.00th<span class="o">=[</span>   40], 60.00th<span class="o">=[</span>   41],
     | 70.00th<span class="o">=[</span>   42], 80.00th<span class="o">=[</span>   51], 90.00th<span class="o">=[</span>   53], 95.00th<span class="o">=[</span>   59],
     | 99.00th<span class="o">=[</span>   70], 99.50th<span class="o">=[</span>   75], 99.90th<span class="o">=[</span>  174], 99.95th<span class="o">=[</span>  284],
     | 99.99th<span class="o">=[</span>  284]
   bw <span class="o">(</span>  KiB/s<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>14336, <span class="nv">max</span><span class="o">=</span>28672, <span class="nv">per</span><span class="o">=</span>100.00%, <span class="nv">avg</span><span class="o">=</span>24538.99, <span class="nv">stdev</span><span class="o">=</span>2120.84, <span class="nv">samples</span><span class="o">=</span>166
   iops        : <span class="nv">min</span><span class="o">=</span>   14, <span class="nv">max</span><span class="o">=</span>   28, <span class="nv">avg</span><span class="o">=</span>23.96, <span class="nv">stdev</span><span class="o">=</span> 2.07, <span class="nv">samples</span><span class="o">=</span>166
  lat <span class="o">(</span>msec<span class="o">)</span>   : <span class="nv">20</span><span class="o">=</span>0.20%, <span class="nv">50</span><span class="o">=</span>78.55%, <span class="nv">100</span><span class="o">=</span>21.05%, <span class="nv">250</span><span class="o">=</span>0.15%, <span class="nv">500</span><span class="o">=</span>0.05%
  cpu          : <span class="nv">usr</span><span class="o">=</span>0.24%, <span class="nv">sys</span><span class="o">=</span>0.43%, <span class="nv">ctx</span><span class="o">=</span>2022, <span class="nv">majf</span><span class="o">=</span>0, <span class="nv">minf</span><span class="o">=</span>0
  IO depths    : <span class="nv">1</span><span class="o">=</span>100.0%, <span class="nv">2</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>0.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     submit    : <span class="nv">0</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>100.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="nv">64</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     <span class="nb">complete</span>  : <span class="nv">0</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>100.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="nv">64</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     issued rwts: <span class="nv">total</span><span class="o">=</span>0,2000,0,0 <span class="nv">short</span><span class="o">=</span>0,0,0,0 <span class="nv">dropped</span><span class="o">=</span>0,0,0,0
     latency   : <span class="nv">target</span><span class="o">=</span>0, <span class="nv">window</span><span class="o">=</span>0, <span class="nv">percentile</span><span class="o">=</span>100.00%, <span class="nv">depth</span><span class="o">=</span>1

Run status group 0 <span class="o">(</span>all <span class="nb">jobs</span><span class="o">)</span>:
  WRITE: <span class="nv">bw</span><span class="o">=</span>23.9MiB/s <span class="o">(</span>25.1MB/s<span class="o">)</span>, 23.9MiB/s-23.9MiB/s <span class="o">(</span>25.1MB/s-25.1MB/s<span class="o">)</span>, <span class="nv">io</span><span class="o">=</span>2000MiB <span class="o">(</span>2097MB<span class="o">)</span>, <span class="nv">run</span><span class="o">=</span>83529-83529msec

Disk stats <span class="o">(</span><span class="nb">read</span>/write<span class="o">)</span>:
  sda: <span class="nv">ios</span><span class="o">=</span>5/4224, <span class="nv">merge</span><span class="o">=</span>0/274, <span class="nv">ticks</span><span class="o">=</span>486/170073, <span class="nv">in_queue</span><span class="o">=</span>173056, <span class="nv">util</span><span class="o">=</span>99.76%
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">shell-2</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c"># shell-2</span>
fio <span class="nt">-filename</span><span class="o">=</span>testfile-0 <span class="nt">-direct</span><span class="o">=</span>1 <span class="nt">-iodepth</span> 1 <span class="nt">-thread</span> <span class="nt">-rw</span><span class="o">=</span>write <span class="nt">-ioengine</span><span class="o">=</span><span class="nb">sync</span> <span class="nt">-bs</span><span class="o">=</span>1M <span class="nt">-size</span><span class="o">=</span>2G <span class="nt">-numjobs</span><span class="o">=</span>1 <span class="nt">-group_reporting</span> <span class="nt">-name</span><span class="o">=</span>sqe_100write_4k
sqe_100write_4k: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>write, <span class="nv">bs</span><span class="o">=(</span>R<span class="o">)</span> 1024KiB-1024KiB, <span class="o">(</span>W<span class="o">)</span> 1024KiB-1024KiB, <span class="o">(</span>T<span class="o">)</span> 1024KiB-1024KiB, <span class="nv">ioengine</span><span class="o">=</span><span class="nb">sync</span>, <span class="nv">iodepth</span><span class="o">=</span>1
fio-3.28
Starting 1 thread
sqe_100write_4k: Laying out IO file <span class="o">(</span>1 file / 2048MiB<span class="o">)</span>
Jobs: 1 <span class="o">(</span><span class="nv">f</span><span class="o">=</span>1<span class="o">)</span>: <span class="o">[</span>W<span class="o">(</span>1<span class="o">)][</span>96.9%][w<span class="o">=</span>97.0MiB/s][w<span class="o">=</span>97 IOPS][eta 00m:03s]
sqe_100write_4k: <span class="o">(</span><span class="nv">groupid</span><span class="o">=</span>0, <span class="nb">jobs</span><span class="o">=</span>1<span class="o">)</span>: <span class="nv">err</span><span class="o">=</span> 0: <span class="nv">pid</span><span class="o">=</span>9984: Fri Nov 26 11:15:59 2021
  write: <span class="nv">IOPS</span><span class="o">=</span>21, <span class="nv">BW</span><span class="o">=</span>21.6MiB/s <span class="o">(</span>22.7MB/s<span class="o">)(</span>2048MiB/94639msec<span class="o">)</span><span class="p">;</span> 0 zone resets
    clat <span class="o">(</span>msec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>2, <span class="nv">max</span><span class="o">=</span>330, <span class="nv">avg</span><span class="o">=</span>46.14, <span class="nv">stdev</span><span class="o">=</span>39.78
     lat <span class="o">(</span>msec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>2, <span class="nv">max</span><span class="o">=</span>330, <span class="nv">avg</span><span class="o">=</span>46.20, <span class="nv">stdev</span><span class="o">=</span>39.78
    clat percentiles <span class="o">(</span>msec<span class="o">)</span>:
     |  1.00th<span class="o">=[</span>    9],  5.00th<span class="o">=[</span>    9], 10.00th<span class="o">=[</span>    9], 20.00th<span class="o">=[</span>   11],
     | 30.00th<span class="o">=[</span>   11], 40.00th<span class="o">=[</span>   11], 50.00th<span class="o">=[</span>   11], 60.00th<span class="o">=[</span>   75],
     | 70.00th<span class="o">=[</span>   77], 80.00th<span class="o">=[</span>   86], 90.00th<span class="o">=[</span>   88], 95.00th<span class="o">=[</span>  100],
     | 99.00th<span class="o">=[</span>  142], 99.50th<span class="o">=[</span>  153], 99.90th<span class="o">=[</span>  257], 99.95th<span class="o">=[</span>  296],
     | 99.99th<span class="o">=[</span>  330]
   bw <span class="o">(</span>  KiB/s<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span> 4096, <span class="nv">max</span><span class="o">=</span>102400, <span class="nv">per</span><span class="o">=</span>100.00%, <span class="nv">avg</span><span class="o">=</span>22159.58, <span class="nv">stdev</span><span class="o">=</span>27573.21, <span class="nv">samples</span><span class="o">=</span>189
   iops        : <span class="nv">min</span><span class="o">=</span>    4, <span class="nv">max</span><span class="o">=</span>  100, <span class="nv">avg</span><span class="o">=</span>21.64, <span class="nv">stdev</span><span class="o">=</span>26.93, <span class="nv">samples</span><span class="o">=</span>189
  lat <span class="o">(</span>msec<span class="o">)</span>   : <span class="nv">4</span><span class="o">=</span>0.05%, <span class="nv">10</span><span class="o">=</span>10.60%, <span class="nv">20</span><span class="o">=</span>40.92%, <span class="nv">50</span><span class="o">=</span>0.44%, <span class="nv">100</span><span class="o">=</span>44.58%
  lat <span class="o">(</span>msec<span class="o">)</span>   : <span class="nv">250</span><span class="o">=</span>3.27%, <span class="nv">500</span><span class="o">=</span>0.15%
  cpu          : <span class="nv">usr</span><span class="o">=</span>0.22%, <span class="nv">sys</span><span class="o">=</span>0.45%, <span class="nv">ctx</span><span class="o">=</span>4171, <span class="nv">majf</span><span class="o">=</span>0, <span class="nv">minf</span><span class="o">=</span>0
  IO depths    : <span class="nv">1</span><span class="o">=</span>100.0%, <span class="nv">2</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>0.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     submit    : <span class="nv">0</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>100.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="nv">64</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     <span class="nb">complete</span>  : <span class="nv">0</span><span class="o">=</span>0.0%, <span class="nv">4</span><span class="o">=</span>100.0%, <span class="nv">8</span><span class="o">=</span>0.0%, <span class="nv">16</span><span class="o">=</span>0.0%, <span class="nv">32</span><span class="o">=</span>0.0%, <span class="nv">64</span><span class="o">=</span>0.0%, <span class="o">&gt;=</span><span class="nv">64</span><span class="o">=</span>0.0%
     issued rwts: <span class="nv">total</span><span class="o">=</span>0,2048,0,0 <span class="nv">short</span><span class="o">=</span>0,0,0,0 <span class="nv">dropped</span><span class="o">=</span>0,0,0,0
     latency   : <span class="nv">target</span><span class="o">=</span>0, <span class="nv">window</span><span class="o">=</span>0, <span class="nv">percentile</span><span class="o">=</span>100.00%, <span class="nv">depth</span><span class="o">=</span>1

Run status group 0 <span class="o">(</span>all <span class="nb">jobs</span><span class="o">)</span>:
  WRITE: <span class="nv">bw</span><span class="o">=</span>21.6MiB/s <span class="o">(</span>22.7MB/s<span class="o">)</span>, 21.6MiB/s-21.6MiB/s <span class="o">(</span>22.7MB/s-22.7MB/s<span class="o">)</span>, <span class="nv">io</span><span class="o">=</span>2048MiB <span class="o">(</span>2147MB<span class="o">)</span>, <span class="nv">run</span><span class="o">=</span>94639-94639msec

Disk stats <span class="o">(</span><span class="nb">read</span>/write<span class="o">)</span>:
  sda: <span class="nv">ios</span><span class="o">=</span>5/6301, <span class="nv">merge</span><span class="o">=</span>0/298, <span class="nv">ticks</span><span class="o">=</span>486/181046, <span class="nv">in_queue</span><span class="o">=</span>184194, <span class="nv">util</span><span class="o">=</span>99.70%
</pre></td></tr></tbody></table></code></pre></div></div>

<p>A控制组下的延时情况：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>clat <span class="o">(</span>msec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>13, <span class="nv">max</span><span class="o">=</span>285, <span class="nv">avg</span><span class="o">=</span>41.69, <span class="nv">stdev</span><span class="o">=</span>11.32
     lat <span class="o">(</span>msec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>13, <span class="nv">max</span><span class="o">=</span>285, <span class="nv">avg</span><span class="o">=</span>41.75, <span class="nv">stdev</span><span class="o">=</span>11.32
    clat percentiles <span class="o">(</span>msec<span class="o">)</span>:
     |  1.00th<span class="o">=[</span>   23],  5.00th<span class="o">=[</span>   27], 10.00th<span class="o">=[</span>   36], 20.00th<span class="o">=[</span>   37],
     | 30.00th<span class="o">=[</span>   37], 40.00th<span class="o">=[</span>   39], 50.00th<span class="o">=[</span>   40], 60.00th<span class="o">=[</span>   41],
     | 70.00th<span class="o">=[</span>   42], 80.00th<span class="o">=[</span>   51], 90.00th<span class="o">=[</span>   53], 95.00th<span class="o">=[</span>   59],
     | 99.00th<span class="o">=[</span>   70], 99.50th<span class="o">=[</span>   75], 99.90th<span class="o">=[</span>  174], 99.95th<span class="o">=[</span>  284],
     | 99.99th<span class="o">=[</span>  284]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>未加<code class="language-plaintext highlighter-rouge">lo.latency</code>的情况：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>clat <span class="o">(</span>msec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>2, <span class="nv">max</span><span class="o">=</span>330, <span class="nv">avg</span><span class="o">=</span>46.14, <span class="nv">stdev</span><span class="o">=</span>39.78
     lat <span class="o">(</span>msec<span class="o">)</span>: <span class="nv">min</span><span class="o">=</span>2, <span class="nv">max</span><span class="o">=</span>330, <span class="nv">avg</span><span class="o">=</span>46.20, <span class="nv">stdev</span><span class="o">=</span>39.78
    clat percentiles <span class="o">(</span>msec<span class="o">)</span>:
     |  1.00th<span class="o">=[</span>    9],  5.00th<span class="o">=[</span>    9], 10.00th<span class="o">=[</span>    9], 20.00th<span class="o">=[</span>   11],
     | 30.00th<span class="o">=[</span>   11], 40.00th<span class="o">=[</span>   11], 50.00th<span class="o">=[</span>   11], 60.00th<span class="o">=[</span>   75],
     | 70.00th<span class="o">=[</span>   77], 80.00th<span class="o">=[</span>   86], 90.00th<span class="o">=[</span>   88], 95.00th<span class="o">=[</span>  100],
     | 99.00th<span class="o">=[</span>  142], 99.50th<span class="o">=[</span>  153], 99.90th<span class="o">=[</span>  257], 99.95th<span class="o">=[</span>  296],
     | 99.99th<span class="o">=[</span>  330]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>从上可以看出，延时在50ms以上的情况，A控制组作用下的<code class="language-plaintext highlighter-rouge">fio</code>结果更好。</p>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2021/11/04/linux-namespace/" data-toggle="tooltip" data-placement="top" title="Linux Namespace">
                        Previous<br>
                        <span>Linux Namespace</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2021/12/05/dns/" data-toggle="tooltip" data-placement="top" title="DNS服务与配置">
                        Next<br>
                        <span>DNS服务与配置</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0011" 
                    href="/archive/?tag=Linux"
                    title="Linux"
                    rel="3">Linux</a>
        
                <a data-sort="0008" 
                    href="/archive/?tag=Docker"
                    title="Docker"
                    rel="6">Docker</a>
        
                <a data-sort="0011" 
                    href="/archive/?tag=docker"
                    title="docker"
                    rel="3">docker</a>
        
                <a data-sort="0012" 
                    href="/archive/?tag=container"
                    title="container"
                    rel="2">container</a>
        
                <a data-sort="0012" 
                    href="/archive/?tag=docker+image"
                    title="docker image"
                    rel="2">docker image</a>
        
                <a data-sort="0012" 
                    href="/archive/?tag=nsenter"
                    title="nsenter"
                    rel="2">nsenter</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "cheneyyin";
    var disqus_identifier = "/2021/11/11/cgroup-v2";
    var disqus_url = "https://cheneyyin.github.io/2021/11/11/cgroup-v2/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/cheney-yin-77">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">知</i>
      </span>
    </a>
  </li>
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/CheneyYin">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Cheney.Yin Blog 2023
                    <br>
                    Powered by <a href="http://cheneyyin.github.io">Cheney.Yin Blog</a> |
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"
                        height="20px"
                        src="https://ghbtns.com/github-btn.html?user=CheneyYin&repo=cheneyyin.github.io&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMZ19PZE4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMZ19PZE4D');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>

</body>

</html>
