---
layout: post
title: "Metal"
subtitle: "介绍自研项目Metal的设计思路和效果"
date: 2023-02-15
author: "Cheney.Yin"
header-img: "img/bg-material.jpg"
project: true
tags:
 - Spark
 - Dataflow
 - 可视化
 - ETL
 - Metal
---

# What is Metal?

Metal是一款数据流建模软件，通过Metal可以管理数据流处理算子、可视化建模、批处理任务执行。


# What Metal can do for me?

如果你经常使用Spark SQL开发ETL Pipeline，积累了大量的DTD(Dataframe To Dataframe)的算子/操作，你可以按照Metal的插件规范改造你的算子/操作，使用Metal来管理这些插件。

如果你使用Metal，你可以很方便地复用这些插件。Metal提供了两种方式来构建数据流，数据流是由插件组合而成的。

- 第一种构建方式是Cli风格，你需要编写spec文件来配置数据流的结构以及数据处理算子的参数。
- 第二方式是可视化风格，Metal提供了用于数据流设计的Web UI即metal-ui。metal-ui是一个简易的数据流集成开发环境，相比于Cli风格，metal-ui降低了配置数据流的难度。metal-ui以Project的概念管理每个数据流。你可以在metal-ui中，创建Project、配置Project、绘制数据流、跟踪数据处理任务、管理算子插件等。

# Features

# Architecture

Metal项目目前包括如下几个组件，

```shell
.
├── metal-backend
├── metal-backend-api
├── metal-core
├── metal-maven-plugin
├── metal-on-spark
├── metal-on-spark-extensions
├── metal-parent
├── metal-server
├── metal-test
└── metal-ui
```

各个组件概况如下：

## metal-core

`metal-core`是Metal的核心，它定义了Metal数据流处理算子类型、数据流分析检查以及执行。

### 数据流处理算子

### 类型

Metal数据流处理算子包括四种，分别为Source、Mapper、Fusion和Sink。

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="/img/resources/metal-plugin-class.svg" width = "95%" alt=""/>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">
      数据流算子类型
  	</div>
</center>

从上图可以看出，所有算子/操作的最终父类为`Metal`，所有继承`Metal`的子类都有`id`、`name`以及配置属性`props`。其中，`props`用于为算子注入配置。`metal-core`下的Metal抽象算子是平台无关的。目前，Metal仅支持将Spark作为后端执行引擎。
上图中`MSource`、`MMapper`、`MFusion`和`MSink`定义了数据流的四种基本处理逻辑。

- `MSource`: 用于获取数据，没有数据输入，有输出。例如`JsonFileSource`是`MSource`在Spark上的一种实现。`JsonFileSource`用从文件中加载JSON格式的数据，返回一个带有模式的DataFrame。
- `MMapper`：用于处理数据，拥有一个输入，并且有输出。例如`SqlMMapper`是`MMapper`在Spark上的一种实现，能够让用户把输入的DataFrame作为一张表，编写SQL处理输入的DataFrame处理得到新的DataFrame。
- `MFusion`：和`MMapper`类似都是用于处理数据，但是`MFusion`必须有两个及以上的输入。例如`SqlMFusion`，它的功能和`SqlMMapper`类似，但是必须输入两张及以上的DataFrame。
- `MSink`：用于下沉数据（写入文件、消息队列等），拥有一个输入，没有输出。例如`ConsoleMSink`是`MSink`在Spark上一种实现，能够把输入的DataFrame输出在控制台上，常用于调试。

### 扩展

Metal提供了算子扩展能力，你需要按照如下步骤实现新的`Metal`子类，然后打包注册即可。

- 首先，根据算子输入、输出的数量来选择算子类型。例如，你需要实现拥有一个输入、一个输出的处理算子，那么你应该选择`MMapper`作为算子的父类。
- 然后，实现一个`MMapper`的子类。如果你的算子是封装的Spark SQL处理逻辑，那么你可以直接实现`SparkMMapper`的子类。
- 最后，你需要在你的工程中配置`metal-maven-plugin`或者直接使用`metal-maven-plugin`命令行来生成注册清单`manifest.json`。向Metal提交注册清单即可完成注册。

## 数据流Spec

数据流处理结构和算子配置定义在数据流Spec。数据流Spec包括`version`、`metals`、`edges`、`waitFor`四个部分。

- `version`：Spec的版本号。
- `metals`：定义了一组Metal，每个Metal定义中包含了Metal的类型、id、名称和其它算子配置信息。
- `edges`：定义了一组数据流向。每个edge包含了起止Metal的id。在`eges`可以建立一个数据流的DAG。
- `waitFor`：定义了`MSink`执行优先级的DAG。

如下是一个简单的数据流Spec示例，

```json
{
  "version" : "1.0",
  "metals" : [ {
    "type" : "org.metal.backend.spark.extension.JsonFileMSource",
    "id" : "00-00",
    "name" : "source-00",
    "props" : {
      "schema" : "",
      "path" : "src/test/resources/test.json"
    }
  }, {
    "type" : "org.metal.backend.spark.extension.SqlMMapper",
    "id" : "01-00",
    "name" : "mapper-00",
    "props" : {
      "tableAlias" : "source",
      "sql" : "select * from source where id != \"0001\""
    }
  }, {
    "type" : "org.metal.backend.spark.extension.ConsoleMSink",
    "id" : "02-00",
    "name" : "sink-00",
    "props" : {
      "numRows" : 10
    }
  }, {
    "type" : "org.metal.backend.spark.extension.ConsoleMSink",
    "id" : "02-01",
    "name" : "sink-01",
    "props" : {
      "numRows" : 10
    }
  } ],
  "edges" : [ {
    "left" : "00-00",
    "right" : "01-00"
  }, {
    "left" : "01-00",
    "right" : "02-00"
  }, {
    "left" : "00-00",
    "right" : "02-01"
  } ],
  "waitFor" : [ {
    "left" : "02-00",
    "right" : "02-01"
  } ]
}
```

<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="/img/resources/metal-spec.svg" width = "95%" alt=""/>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">
      数据流示例
  	</div>
</center>

在示例中，source-00会从`src/test/resources/test.json`获取JSON数据，mapper-00将source-00作为输入并且筛选出`id != "0001"`的记录，sink-00将mapper-00过滤出的数据打印在控制台。sink-00会直接将source-00的数据打印在控制台。

# Open Source Plan

